## README

### How to run the experiments
**Running on Cluster**: Create venv according to guide here https://github.com/VMarsocci/pangaea-bench and load Python module (version = 3.12.8). Run sbatch files after changing the paths to the environment and to the PANGAEA code structure. Requires access to AGBD data in in work share of cluster. Adapt parameters in sbatch file if wanted.

**Running locally**: take the torchrun commands from the sbatch files in /1_sbatch_files/SatMAE_AGBD_PANGAEA_multi_GPU_._exp and adapt accordingly (change "--nproc_per_node=8" to "--nproc_per_node=1", remove "--rdzv-backend=c10d" as well as "--rdzv-endpoint=localhost:0", change "test_num_workers" and "num_workers" according to your what your hardware can handle, change the "dataset.*" paths to the paths where the data is stored)

**Important to adapt in any case:**
- In /pangaea/utils/schedulers.py: Change the LR scheduler accordingly; use fixed step size when running main experiment + Ablation 1 + Ablation 2; for Ablation 3 use original code, hence the PANGAEA default
- In /configs/train.yaml and /configs/test.yaml: Adapt the path in "work_dir", telling where to save the results of the experiment (this should be also doable from the command line when starting the job)

The following files and folders have been changed from the GitHub Repository version from 22. May 2025 (all updates after this date have not been incorporated into this code). For details, please refer to the files. It can be, that some files did not change fundamentally, but some commentary was added.

### Changed files and folders
- /configs/dataset/agbd.yaml (added)
- /configs/encoder/satmae_base.yaml (added)
- /configs/optimizer/adamw.yaml (changed lr and betas: modified to fit SatMAE pre-training configuration)
- /configs/preprocessing/reg_agbd_resize.yaml (added)
- /configs/train.yaml (changed; specified "work_dir" in case running on cluster, add option to print and log the model)
- /configs/test.yaml (changed: specified "work_dir" in case running on cluster)
- /pangaea/datasets/agdb.py (added)
- /pangaea/datasets/base.py (changed: added comments)
- /pangaea/encoders/satmae_base_encoder.py (added)
- /pangaea/engine/data_preprocessor.py (changed: new class added "HorizontalFlip", changed interpolation method; see also below)
- /pangaea/engine/evaluator (changed: implemented sparse mse, add metrics, add visualization, added libraries needed, introduce variable "testing_bool" to save testing metrics, added "weights_only=False" due to FutureWarning)
- /pangaea/engine/trainer (changed: change name of WandB logs, added comments, implemented sparse mse)
- /pangaea/utils/schedulers.py (changed: hardcoded fixed lr for n_epochs<=10 -> needs to be changed manually when running main experiment + Ablation 1 + Ablation 2)
- run.py (changed: create new .csv file for testing metrics, implement print model option, added comments, variable to save testing metrics, added needed libraries)


Files adapted for debugging purposes, not related to SatMAE or AGBD integration:
- /pangaea/datasets/biomassters.py (changed: changed line where "self.split_path" is defined; debug)
- /pangaea/encoders/scalemae_encoder.py (changed: added "weights_only=False" due to FutureWarning)
- /pangaea/engine/data_preprocessor.py (changes to class "BandPadding(BasePreprocessor)")



### Structure
- in "1_sbatch_files", the sbatch files used to run the final experiments are stored
- in "2_Final_Experiments", the training logs as well as the pre-trained models (one per epoch) are saved. Furthermore, the metrics for the testing phase are saved if available. (one folder with 2025* has the output from the experiment, one folder with 3* contains the output from the Euler cluster log, one folder "wandb_log" contains the metrics and the log information sent to WandB)
- "configs" has all .yaml files relevant to define the experiment
- "pangaea" contains all .py files needed to run the code, including "run.py"
- "tests" consists of scripts to test the code
- the other files are there for information purposes and have the requirements to set up the needed environment

**Further information can be retrieved from the comments within the files and from https://github.com/VMarsocci/pangaea-bench.**

